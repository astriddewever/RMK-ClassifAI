<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Classifier</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.3/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>    

    <style>
        body {
            font-family: 'Lato', sans-serif; 
            text-align: center;
            padding: 20px;
        }
        input[type="file"] {
            margin: 20px;
        }
        #results {
            margin-top: 20px;
        }
        img {
            max-width: 200px;
            margin: 10px;
        }
        #logo {
            max-width: 150px;
            margin: 20px auto;
        }
        #description {
            margin: 20px auto;
            max-width: 800px;
        }
    </style>
</head>
<body>
    <img id="logo" src="https://www.rmk.be/wp-content/uploads/2018/09/RMK_WEB_LOGO_nav-01.png" alt="RMK Logo">
    <h1>Marketing ClassifAI</h1>
    <p id="description">
        This tool uses a machine learning model trained with Google's Teachable Machine to classify RMK's images based on the predefined categories. Upload your images, and the tool will predict and classify them into one of the categories or mark them as uncertain if the prediction confidence is low. You can then download a ZIP file containing your classified images.
    </p>
    <input type="file" id="image-upload" multiple accept=".jpg,.jpeg,.png">

    <button id="download-results">Download resultaten</button>
    <div id="results"></div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/EKzHUSSK9/";
        let model, maxPredictions;

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
    
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            console.log("Model loaded");
        }

        init();

        document.getElementById('image-upload').addEventListener('change', async (event) => {
            const files = event.target.files;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ""; // Clear previous results

            const zip = new JSZip();
            const uncertainFolder = zip.folder("Class not sure");

            for (let file of files) {
                if (!file.type.startsWith("image/")) continue; // Skip non-image files
                const image = await loadImage(file);
                const predictions = await model.predict(image);
                await addImageToZip(file, predictions, zip, uncertainFolder);

                // Display image with results
                const imgElement = document.createElement('img');
                imgElement.src = URL.createObjectURL(file);
                imgElement.alt = file.name;
                const resultText = document.createElement('p');
                resultText.textContent = predictions.map(p => `${p.className}: ${Math.round(p.probability * 100)}%`).join(", ");
                resultsDiv.appendChild(imgElement);
                resultsDiv.appendChild(resultText);
            }

            // Attach event listener to the download button
            document.getElementById('download-results').addEventListener('click', () => {
                zip.generateAsync({ type: "blob" }).then(content => {
                    saveAs(content, "classified_images.zip");
                }).catch(error => console.error("Error generating ZIP file:", error));
            });
        });

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function addImageToZip(file, predictions, zip, uncertainFolder) {
            const reader = new FileReader();
            reader.onloadend = function () {
                const imgBase64 = reader.result.split(',')[1]; // Extract base64 part of the image data URL
                const imgName = file.name;

                // Find the prediction with the highest probability
                const topPrediction = predictions.reduce((max, p) => p.probability > max.probability ? p : max, { probability: 0 });

                let folderName;
                if (topPrediction.probability > 0.60) {
                    folderName = topPrediction.className;
                } else {
                    folderName = "Class not sure";
                }

                // Create or get the appropriate folder
                let folder = zip.folder(folderName);

                // Add image to the corresponding folder
                folder.file(imgName, imgBase64, { base64: true });
            };

            // Read the image file as data URL
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
